<!DOCTYPE html>
<html>
<head>
    <title>Meesho Label Optimizer | Label Crop Tool</title>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { 
            --meesho-pink: #9f2089; 
            --meesho-dark: #222; 
            --flipkart-blue: #2874f0;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #fdf0f5; padding: 0; color: var(--meesho-dark); margin: 0; }
        
        /* AD LAYOUT WRAPPER */
        .page-layout {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .ad-sidebar {
            width: 160px;
            min-height: 600px;
            background: white;
            border: 2px dashed #ddd;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            position: sticky;
            top: 20px;
            text-align: center;
        }

        .wrapper { flex: 1; max-width: 850px; display: flex; flex-direction: column; }

        .header-section { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: white;
            border-radius: 20px;
            padding: 15px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border-bottom: 6px solid var(--meesho-pink);
        }

        .main-heading { font-size: 20px; font-weight: bold; color: var(--meesho-pink); flex: 1; }
        
        .flipkart-link-area {
            padding: 12px 25px;
            background: var(--flipkart-blue);
            color: white;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: 0.3s;
        }
        .flipkart-link-area:hover { background: #1a5abd; transform: translateY(-2px); }
        
        .card { 
            background: white; 
            padding: 40px; 
            border-radius: 25px; 
            box-shadow: 0 15px 35px rgba(159, 32, 137, 0.1); 
            border-top: 10px solid var(--meesho-pink); 
        }

        #drop-area { 
            border: 3px dashed #ddd; 
            border-radius: 15px; 
            padding: 60px 20px; 
            background: #fffafc; 
            cursor: pointer; 
            font-weight: bold; 
            color: var(--meesho-pink); 
            font-size: 24px; 
            text-align: center; 
        }

        .btn-start { 
            background: var(--meesho-pink); 
            color: white; border: none; padding: 20px; width: 100%; border-radius: 12px; font-size: 26px; cursor: pointer; display: none; margin-top: 20px; font-weight: bold; 
        }

        #history-box { width: 100%; background: #fff; border-radius: 12px; padding: 20px; margin-top: 15px; box-sizing: border-box; border: 2px solid #f3e5f5;}
        .file-entry { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }

        @media (max-width: 1200px) {
            .ad-sidebar { display: none; }
        }
    </style>
</head>
<body>

<div class="page-layout">
    <div class="ad-sidebar">Advertisement<br>Space</div>

    <div class="wrapper">
        <div class="header-section">
            <div class="main-heading">Meesho Shipping Labels (SKU Sort)</div>
            <a href="../index.html" class="flipkart-link-area">Flipkart 3x5</a>
        </div>

        <div class="card">
            <div id="drop-area">DRAG & DROP MEESHO LABELS HERE</div>
            <div style="margin-top: 20px; text-align: center;">
                <input type="checkbox" id="showStamp" checked>
                <label for="showStamp">Include Date and Time Stamp</label>
            </div>
            <input type="file" id="picker" multiple accept=".pdf" style="display:none">
            <button id="runBtn" class="btn-start" onclick="processPDFs()">GENERATE LABELS</button>
        </div>

        <div id="history-box" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #f3e5f5; padding-bottom:10px; margin-bottom:15px;">
                <h2 style="margin:0; font-size:20px; color:var(--meesho-pink);">Labels in Queue</h2>
                <button onclick="clearFiles()" style="background:#f5f5f5; color:#ff4d4d; border:1px solid #ff4d4d; padding:8px 15px; border-radius:8px; cursor:pointer; font-weight:bold;">RESET ALL</button>
            </div>
            <div id="file-list"></div>
        </div>
    </div>

    <div class="ad-sidebar">Advertisement<br>Space</div>
</div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let selectedFiles = []; 
    let fileCounter = 0;

    const dropArea = document.getElementById('drop-area');
    const picker = document.getElementById('picker');
    const runBtn = document.getElementById('runBtn');
    const historyBox = document.getElementById('history-box');
    const fileListDiv = document.getElementById('file-list');

    dropArea.onclick = () => picker.click();
    picker.onchange = (e) => handleFiles(e.target.files);

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(n => {
        dropArea.addEventListener(n, e => { e.preventDefault(); e.stopPropagation(); }, false);
    });

    dropArea.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files), false);

    function handleFiles(files) {
        const newFiles = Array.from(files).filter(f => f.type === "application/pdf");
        newFiles.forEach(file => {
            const fileDate = new Date(file.lastModified); 
            const dateStr = `${fileDate.getDate().toString().padStart(2,'0')}-${(fileDate.getMonth()+1).toString().padStart(2,'0')}-${fileDate.getFullYear()}`;
            const timeStr = fileDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            const id = fileCounter++;
            selectedFiles.push({ id, file, originalStamp: `Downloaded: ${dateStr} | ${timeStr}` });
            
            const entry = document.createElement('div');
            entry.className = 'file-entry';
            entry.id = `file-${id}`;
            entry.innerHTML = `
                <div>
                    <div style="color:#666; font-size:13px; margin-bottom: 2px;">${file.name}</div>
                    <div style="font-weight:bold; font-size:14px;">${dateStr} | ${timeStr}</div>
                </div>
                <button style="background:#ff4d4d; color:white; border:none; border-radius:8px; width:40px; height:40px; cursor:pointer;" onclick="removeFile(${id})">ðŸ—‘</button>
            `;
            fileListDiv.appendChild(entry);
        });
        updateUI();
    }

    function removeFile(id) {
        selectedFiles = selectedFiles.filter(f => f.id !== id);
        const el = document.getElementById(`file-${id}`);
        if(el) el.remove();
        updateUI();
    }

    function updateUI() {
        historyBox.style.display = selectedFiles.length > 0 ? 'block' : 'none';
        runBtn.style.display = selectedFiles.length > 0 ? 'block' : 'none';
    }

    function clearFiles() {
        selectedFiles = [];
        fileListDiv.innerHTML = "";
        updateUI();
        picker.value = "";
    }

    async function processPDFs() {
        runBtn.innerText = "PROCESSING...";
        runBtn.disabled = true;
        
        const now = new Date();
        const exportDateStr = `${now.getDate().toString().padStart(2,'0')}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getFullYear()}`;
        const exportTimeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }).replace(/:/g, '-');
        const fileName = `Meesho ${exportDateStr} ${exportTimeStr}.pdf`;
        const includeStamp = document.getElementById('showStamp').checked;

        let pageList = [];
        for (let obj of selectedFiles) {
            const buffer = await obj.file.arrayBuffer();
            const pdfDoc = await PDFLib.PDFDocument.load(buffer);
            const reader = await pdfjsLib.getDocument({data: buffer}).promise;

            for (let i = 1; i <= pdfDoc.getPageCount(); i++) {
                const page = await reader.getPage(i);
                const text = await page.getTextContent();
                const items = text.items.map(t => ({
                    str: t.str.replace(/["'\[\],]/g, "").trim(),
                    y: t.transform[5]
                })).filter(item => item.str !== "");

                const skuItem = items.find(item => item.str.toUpperCase() === "SKU");
                if (!skuItem) continue; 

                const skuY = skuItem.y;
                const bottomLineItems = items.filter(item => item.y < skuY).sort((a,b) => b.y - a.y);
                let collectedParts = [];
                for (let item of bottomLineItems) {
                    if (item.str.toLowerCase().includes("free") || item.str.toLowerCase().includes("size")) break;
                    collectedParts.push(item.str);
                }
                const realSku = collectedParts.join("").trim() || "ZZZ_UNKNOWN";

                let highQtyFound = false;
                let qtyY = 0;
                const sizeLine = items.filter(item => item.str.toLowerCase().includes("free") || item.str.toLowerCase().includes("size"));
                for (let sItem of sizeLine) {
                    const sameLine = items.filter(item => Math.abs(item.y - sItem.y) < 5);
                    for (let lItem of sameLine) {
                        const num = parseInt(lItem.str);
                        if (!isNaN(num) && num > 1 && lItem.str.length < 4) {
                            highQtyFound = true;
                            qtyY = sItem.y;
                        }
                    }
                }
                pageList.push({ sku: realSku, doc: pdfDoc, idx: i - 1, highlight: highQtyFound, highlightY: qtyY, stamp: obj.originalStamp });
            }
        }

        pageList.sort((a, b) => a.sku.localeCompare(b.sku, undefined, { numeric: true, sensitivity: 'base' }));

        const finalPdf = await PDFLib.PDFDocument.create();
        for (const p of pageList) {
            const [copied] = await finalPdf.copyPages(p.doc, [p.idx]);
            if (p.highlight) {
                copied.drawRectangle({
                    x: 5, y: p.highlightY - 5,
                    width: copied.getWidth() - 10, height: 18,
                    borderColor: PDFLib.rgb(0, 0, 0), borderWidth: 3, opacity: 1
                });
            }
            if (includeStamp) {
                copied.drawText(p.stamp, { x: 20, y: 25, size: 12, color: PDFLib.rgb(0, 0, 0) });
            }
            finalPdf.addPage(copied);
        }

        const pdfBytes = await finalPdf.save();
        const link = document.createElement('a');
        link.href = URL.createObjectURL(new Blob([pdfBytes], { type: 'application/pdf' }));
        link.download = fileName;
        link.click();
        
        runBtn.innerText = "GENERATE LABELS";
        runBtn.disabled = false;
    }
</script>
</body>
</html>
